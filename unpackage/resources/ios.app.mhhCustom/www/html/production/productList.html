<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>项目列表</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/common.css" />
		<link rel="stylesheet" href="../../css/iconfont.css" />
		<link rel="stylesheet" href="../../css/loading.css" />
		<link rel="stylesheet" href="../../css/animate.css" />
		<style>
			/*分类*/
			
			.block0 {
				background: #fff;
				height: 44px;
				line-height: 44px;
				border-bottom: 1px solid #d3d3d3;
			}
			
			.block0 li {
				position: relative;
			}
			
			.block0 li.active {
				color: #ccaa42;
			}
			
			.block0 li.active::before {
				content: '';
				position: absolute;
				bottom: 0;
				width: 100%;
				left: 0;
				height: 4px;
				background: #ccaa42;
			}
			/*筛选条件*/
			
			.block1 {
				background: #fff;
			}
			
			.filterBars {
				height: 44px;
				line-height: 44px;
				border-bottom: 1px solid #d3d3d3;
				box-sizing: border-box;
				width: 100%;
			}
			
			.filterBars>li:last-child {
				border: none;
			}
			
			.filterBars li {
				border-right: 1px dotted #d3d3d3;
			}
			
			.filterBars li.active,
			.filterBars li.active>span {
				color: #ccaa42;
			}
			
			.filterBars li,
			.filterBars span,
			.filterBars i {
				color: #606060;
				font-size: 14px;
			}
			
			.filterBars span.rotate {
				transform: rotate(90deg);
				-webkit-transform: rotate(90deg);
				transition: all .3s ease;
			}
			
			.filterBars span,
			.filterBars i {
				margin-left: 5px;
			}
			/*列表*/
			
			.proLists {
				position: absolute;
				bottom: 0;
				overflow: hidden;
				width: 100%;
			}
			
			.cm_search_input {
				text-indent: 20px;
			}
			/*技师*/
			
			.block2 {
				padding: 5px;
				width: 100%;
			}
			
			.block2 .avatar {
				width: 60px;
				height: 60px;
			}
			
			.label_tool {
				height: 18px;
				line-height: 18px;
				background: #ff004d;
				border-radius: 0 8px 8px 0;
				font-size: 10px;
				padding: 0 10px;
				color: #fff;
				margin-bottom: 5px;
			}
			/*筛选*/
			
			.typeItem {
				line-height: 40px;
				padding: 0 10px;
			}
			
			.typeItem.active {
				color: #ccaa42;
			}
			/*模态框定位*/
			
			.loactionBox {
				border-bottom: 1px dotted #d3d3d3;
				line-height: 44px;
				height: 44px;
				background: #fff;
			}
			
			.currPosMark {
				line-height: 44px;
			}
			
			.starsBox {
				/*background: red;*/
				margin-top: 10px;
				border-bottom: 1px dotted #d3d3d3;
			}
			
			.starsBox .stars {
				flex-wrap: wrap;
			}
			
			.starsBox input {
				/*display: none;*/
			}
			
			.starsBox li {
				border: 1px solid #d3d3d3;
				border-radius: 3px;
				padding: 0 5px;
				margin: 10px;
				width: 50px;
				font-size: 12px;
				line-height: 16px;
				text-align: center;
			}
			
			.starsBox li.active {
				border: 1px solid #ccaa42;
				color: #fff;
				background: #ccaa42;
			}
			
			.prizeBox {
				margin-top: 10px;
				border-bottom: 1px dotted #d3d3d3;
			}
			
			.prizes {
				line-height: 40px;
			}
			
			.prizeInput {
				height: 40px;
				line-height: 40px;
				margin: 0 10px;
			}
			
			.list {
				background: #fff;
			}
		</style>
	</head>

	<body>
		<div id="app">

			<!--等待页面-->
			<div class="loader" style="top:0" v-show="loader">
				<ul>
					<li id='a'></li>
					<li id='b'></li>
					<li id='c'></li>
					<li id='d'></li>
					<li id='e'></li>
					<li id='f'></li>
					<li id='g'></li>
					<li id='h'></li>
					<li id='i'></li>
				</ul>
			</div>
			<header class="   header flex" id="header">
				<button class="mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left cor_y"><span class="mui-icon mui-icon-left-nav "></span>返回</button>
				<div class="cm_search f1 flex">
					<i class="iconfont icon-search cor_g"></i>
					<div class="f1 cm_search_input cor_g" @tap="_toSearch">马嘿嘿带你搜点啥？</div>
				</div>
			</header>
			<div class="loactionBox container" @tap="_navigateTo('../address/where.html','where')">
				<!--<div class="flex">
							<div class="f1 lh30">
								服务地址
							</div>
							<div class="f1 lh30 t_r" @tap="_NWnavigateTo('../address/where.html','where')">
								重新选择
							</div>
						</div>-->
				<p class="currPosMark ellipsis"><span class="mui-icon mui-icon-location cor_y"></span>{{currPosMark}}</p>
			</div>

			<!--筛选条件-->
			<div class=" block1">
				<ul class="flex filterBars ">
					<li class="f1 t_c" :class="{active:proType}" @tap="_switchView(2)">
						{{proType?proType:'全部'}}<span class="mui-icon mui-icon-arrowright" :class="{rotate:classShow&&classShowType==1}"></span>
					</li>
					<li class="f1 t_c" :class="{active:sort!=0}" @tap="_switchView(3)">
						{{sort | sortName}}<span class="mui-icon mui-icon-arrowright" :class="{rotate:classShow&&classShowType==2}"></span>
					</li>
					<li class="f1 t_c" @tap="_switchView(1)">
						切换视图
						<span class="mui-icon mui-icon-list" v-show="!viewType"></span>
						<i class="iconfont icon-zonghe" v-show="viewType"></i>
					</li>
				</ul>
			</div>

			<!--项目列表-->
			<div class="proLists  " ref="scroll" :style="{top:scrollTop}">
				<div class="scrollContent ">
					<ul class="reset scrollWrap" :class="{scrollWrap2:!viewType}">
						<!--样式1-->
						<li class="list" :class="viewType?'cm_proItems':'cm_proItems2'" @tap="_NWnavigateTo('../technician/technician.html','technician',{'shopCode':item.SHOP_CODE})" v-for="item in result">
							<article class="flex relative">
								<!--<ul class="cm_label_tool">
									<li v-for="item2 in _getArr(item.SHOP_BUSINESS_TYPE)">{{item2}}</li>
								</ul>-->
								<div class="cm_itemPic ">
									<img :src="item.SHOP_LOGO?item.SHOP_LOGO:'../../images/default_avatar.jpg'" @error="_default" class="cover" />
								</div>
								<div class="f1 cm_txt">
									<h4 class="txt">{{item.SHOP_NAME}}</h4>
									<p class="fs12"> {{item.SHOP_CONCERN}}人关注</p>
									<div class=" flex ">
										<img src="../../images/levelicon.png" alt="" class="cm_level" v-for="item2 in parseInt(item.SHOP_STAR) " />
									</div>

									<p class="lh28">{{item.SHOP_BUSINESS_TYPE}}</p>
									<aside class="cor_g ">
										<div class=" flex">
											<i class="mui-icon mui-icon-map cor_r fs16 " style="margin-right: 10px;"></i>
											<p class=" f1 fs12 txt">{{item.SHOP_ADDRESS}}</p>
										</div>
										<div class=" flex">
											<i class="mui-icon mui-icon-navigate cor_r fs16" style="margin-right: 10px;"></i>
											<p class=" f1 fs12 txt">距离：{{item.DISTANCE}}km</p>
										</div>
									</aside>

								</div>
							</article>

						</li>
					</ul>
					<p class="lh44 t_c">{{node}}</p>

				</div>
			</div>

			<!--模态框-->
			<div class="cm_mask " v-show="modalShow" @tap.self="_modelToggle">
				<div class="cm_modal  animated slideInRight">

					<aside class="starsBox container ">
						<div class="cm_name">星级选择</div>
						<ul class="stars flex">
							<li @tap="_chooseStars(0)" :class="{active:level==0}">全部</li>
							<li @tap="_chooseStars(1)" :class="{active:level==1}">等级1</li>
							<li @tap="_chooseStars(2)" :class="{active:level==2}">等级2</li>
							<li @tap="_chooseStars(3)" :class="{active:level==3}">等级3</li>
							<li @tap="_chooseStars(4)" :class="{active:level==4}">等级4</li>
							<li @tap="_chooseStars(5)" :class="{active:level==5}">等级5</li>
						</ul>

					</aside>
					<!--价格区间筛选-->
					<!--<article class="prizeBox container">
						<div class="cm_name">价格区间</div>
						<div class="flex prizes">
							<input type="number" class="f1 prizeInput" v-model="min" /> ~
							<input type="number" class="f1 prizeInput" v-model="max" />
						</div>
					</article>-->
					<!--确认-->
					<div class="container ">
						<div class="cm_btn" @tap="_submit">确认</div>
					</div>
				</div>
			</div>

			<!--排序及分类模态框-->
			<div class="cm_mask_bot " v-show="classShow" :style="{top:scrollTop}" @tap.self="_switchView(4)">
				<ul class="cm_modal_top  animated slideInDown" v-show="classShowType==1">
					<li class="typeItem" :class="{active:!proType}" @tap="_chooseType('')">全部</li>
					<li class="typeItem" :class="{active:proType=='美妆'}" @tap="_chooseType('美妆')">美妆</li>
					<li class="typeItem" :class="{active:proType=='美甲'}" @tap="_chooseType('美甲')">美甲</li>
					<li class="typeItem" :class="{active:proType=='美睫'}" @tap="_chooseType('美睫')">美睫</li>
					<li class="typeItem" :class="{active:proType=='半永久纹眉'}" @tap="_chooseType('半永久纹眉')">半永久纹眉</li>
					<li class="typeItem" :class="{active:proType=='美体'}" @tap="_chooseType('美体')">美体</li>
					<li class="typeItem" :class="{active:proType=='美容'}" @tap="_chooseType('美容')">美容</li>
					<li class="typeItem" :class="{active:proType=='美发'}" @tap="_chooseType('美发')">美发</li>
				</ul>

				<ul class="cm_modal_top  animated slideInDown" v-show="classShowType==2">
					<li class="typeItem" :class="{active:sort==0}" @tap="_chooseSort(0)">默认排序</li>
					<li class="typeItem" :class="{active:sort==1}" @tap="_chooseSort(1)">人气最高</li>
					<li class="typeItem" :class="{active:sort==2}" @tap="_chooseSort(2)">距离最近</li>
					<li class="typeItem" :class="{active:sort==3}" @tap="_chooseSort(3)">价格最低</li>
					<li class="typeItem" :class="{active:sort==4}" @tap="_chooseSort(4)">价格最高</li>
					<li class="typeItem" :class="{active:sort==5}" @tap="_chooseSort(5)">项目最新</li>
				</ul>
			</div>

		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/app.js"></script>
		<script src="../../js/vue.js"></script>
		<script src="../../js/bscroll.min.js"></script>
		<script src="../../js/aes.js" type="text/javascript" charset="utf-8"></script>

		<script type="text/javascript">
			mui.init({
				swipeBack: true
			});
			var APP;
			mui.plusReady(function() {
				app.WXinit(CryptoJS)
				APP = new Vue({
					el: '#app',
					data: {
						loader: true,
						scroll: '',
						scrollTop: '',
						modalShow: false,
						curType: 1, //*切换手艺人或者项目  1 项目 2手艺人*/
						viewType: true,
						/*是否是块试图*/
						proType: '',
						/*项目类型*/
						sort: 0,
						/*只能排序*/
						classShow: false,
						/*控制分类的模态框显示*/
						classShowType: 1,
						/*控制分类的模态框显示的市分类的选项（1)还是排序的选项(2)*/
						index: 1,
						/*当前页码*/
						result: [],
						node: '查看加载更多',
						/*提示语*/

						/*筛选内容*/
						min: '',
						max: '',
						level: 0,
						/*星级筛选*/
						currPosMark: ''
					},
					created: function() {
						app.initHeader();
						/*获取转过来的项目联系*/
						var self = plus.webview.currentWebview();
						this.proType = self.proType

					},
					filters: {
						sortName(value) {
							switch(value) {
								case 0:
									return '智能排序'
									break;
								case 1:
									return '人气最高'
									break;
								case 2:
									return '距离最近'
									break;
								case 3:
									return '价格最低'
									break;
								case 4:
									return '价格最高'
									break;
								default:
									break;
							}
						}
					},
					mounted: function() {
						//							console.log(app.mark + plus.storage.getItem('token'))
						var _this = this;

						var scroll = this.$refs.scroll
						//							初始化scroll的屏幕位置
						this.scrollTop = document.getElementById('header').offsetHeight + 88 + 'px';

						/*初始化数据*/
						this._getData()

						/*初始化scroll*/
						this.$nextTick(function() {
							//							初始化scrool
							if(!_this.scroll) {
								//							初始化标题栏
								_this.scroll = new BScroll(scroll, {
									click: true,
									probeType: 3,
									bounceTime: 200,
									pullUpLoad: {
										threshold: -20 // 当上拉距离超过30px时触发 pullingUp 事件
									},
									pullDownRefresh: {
										threshold: 50,
										stop: 0
									}
								})

							} else {
								_this.scroll.refresh();
							};
							_this.scroll.on('pullingUp', function() {
								_this._getData((b) => {
									if(b) {

									} else {
										_this.scroll.finishPullUp()

									}
								})
							})
							/*下拉刷新*/
							_this.scroll.on('pullingDown', function(e) {
								plus.nativeUI.showWaiting()
								_this.index = 1;
								_this.node = '查看加载更多';
								_this.result = [];
								_this._getData((b) => {
									plus.nativeUI.closeWaiting()
									if(b) {

									} else {
										_this.scroll.finishPullUp()
									}
									_this.scroll.finishPullDown()
									plus.nativeUI.closeWaiting()
								})
							})

						})
					},
					methods: {
						//						默认头像
						_default(e) {
							var dom = e.target;
							//							console.log(dom)
							dom.src = "../../images/default_avatar.jpg"
						},
						_getArr(str) {
							var arr = str.split(',')
							var res = []
							arr.forEach((item) => {
								res.push(item)
							})
							return res
						},
						_chooseStars(k) {
							this.level = k
							//							alert(this.level)
						},
						/*选择排序*/
						_chooseSort(k) {
							this.sort = k;
							this.index = 1;
							this.node = '查看加载更多';
							this.result = [];
							this._getData();
							this.classShow = false;
						},
						/*选择分类*/
						_chooseType(t) {
							this.proType = t;
							this.index = 1;
							this.node = '查看加载更多';
							this.result = [];
							this._getData();
							this.classShow = false;
							this.scroll.finishPullUp()
						},
						/*切换视图及数据变化*/
						_switchView(t) {
							switch(t) {
								case 1:
									this.viewType = !this.viewType
									break;
								case 2:
									if(this.classShow && this.classShowType == 1) {
										this.classShow = false;
										return
									}
									this.classShow = true
									this.classShowType = 1 /*模态框显示的市分类的选项*/
									break;
								case 3:
									if(this.classShow && this.classShowType == 2) {
										this.classShow = false;
										return
									}

									this.classShow = true
									this.classShowType = 2 /*模态框显示的是排序的选项*/
									break;
								case 4:

									this.classShow = false /*模态框显示的是排序的选项*/
									break;
								default:
									break;
							}

						},
						/*跳转页面*/
						_NWnavigateTo(dstUrl, dstId, extras) {
							let exa = extras
							let option = {

							}
							app.navigater(dstUrl, dstId, exa, option)

						},
						/*跳转页面*/
						_navigateTo(dstUrl, dstId, extras) {
							let exa = extras
							let option = {
								autoShow: false
							}
							app.navigater(dstUrl, dstId, exa, option)

						},
						//						确认筛选
						_submit() {
							this.index = 1
							this.result = []
							plus.nativeUI.showWaiting()
							this._getData(() => {
								plus.nativeUI.closeWaiting()
							})
						},
						/*获取数据*/
						_getData(callback) {

							var _this = this
							let pos = plus.storage.getItem('pos')
							if(!pos) {
								plus.nativeUI.closeWaiting();
								plus.nativeUI.toast('无法获取您的定位，请你刷新')
								plus.webview.currentWebview().close()
								return;
							}

							pos = JSON.parse(pos)

							this.currPosMark = pos.address

							var data = {
								pageIndex: this.index,
								pageSize: 6,
								lon: (pos.longitude).toFixed(6),
								lat: (pos.latitude).toFixed(6),
								SHOP_BUSINESS_TYPE: this.proType,
								ORDER_TYPE: this.sort
								//								distance: 5000
							}

							if(this.min) data.lowest = this.min
							if(this.max) data.highest = this.max
							if(this.level != 0) data.SHOP_STAR = this.level
							//console.log(JSON.stringify(data))
							mui.ajax(app.baseUrl + '/api/Shop/GetShops', {
								data: data,
								type: 'get', //HTTP请求类型
								timeout: 10000, //超时时间设置为10秒；
								headers: {
									'Content-Type': 'application/x-www-form-urlencoded'
								},
								success: function(result) {
									_this.loader = false
									if(result.Success) {

										if(_this.result.length == result.Data.Total) {
											_this.scroll.refresh()
											_this.node = '没有数据了'
											if(callback) callback(true)
											return
										} else {
											_this.result = _this.result.concat(result.Data.ListInfo);
											_this.index += 1;
											mui.later(() => {
												_this.scroll.refresh()
												if(callback) callback(false)
											}, 500)
										}
									} else {
										if(callback) callback()
										plus.nativeUI.toast(result.Msg)
										mui.back()
									}
								},
								error: function(xhr, type, errorThrown) {
									//异常处理；
									_this.loader = false
									app.catchErr(type)
								}
							});
							_this.modalShow = false
						},
						/*刷新*/
						_refreshData() {

						},
						/*回到顶部*/
						_backTop() {
							this.scroll.scrollTo(0, 0, 300)
						},
						/*模态框显示控制*/
						_modelToggle() {
							this.modalShow = !this.modalShow;
							this.classShow = false
						},
						//						跳转搜索页/**/
						_toSearch() {
							let desturl = './search.html'
							let destid = 'search'
							let exa = {}
							let option = {
								autoShow: false
							}
							app.navigater(desturl, destid, exa, option)

						},
						/*切换类型*/
						_switch(k) {
							/*当模态框打开的时候不能切换*/
							if(this.classShow) return;
							k == this.curType && (() => {
								return
							})()
							this.curType = k
						},

					}
				})

			});

			function setPos(a) {
				APP.currPosMark = a

				APP._submit()
			}
		</script>
	</body>

</html>